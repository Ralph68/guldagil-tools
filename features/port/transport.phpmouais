<?php
/**
refonte par claude mais sans plus : incomplet
 * Titre: Classe Transport - VERSION FINALE FONCTIONNELLE
 * Chemin: /features/port/transport.php
 * Version: 0.5 beta + build auto
 */

class Transport {
    private PDO $db;
    public array $debug = [];
    
    private array $tables = [
        'xpo' => 'gul_xpo_rates',
        'heppner' => 'gul_heppner_rates'
    ];
    
    private array $carrierNames = [
        'xpo' => 'XPO Logistics',
        'heppner' => 'Heppner'
    ];
    
    public function __construct(PDO $db) {
        $this->db = $db;
        $this->debug = [];
    }
    
    /**
     * Calcule les tarifs pour tous les transporteurs
     */
    public function calculateAll(array $params): array {
        $results = [];
        $this->debug = ['input' => $params];
        
        // Normalisation des paramètres
        $normalized = $this->normalizeParams($params);
        $this->debug['normalized'] = $normalized;
        
        // Règle métier : poids > 60kg = forcément palette
        if ($normalized['poids'] > 60 && $normalized['type'] === 'colis') {
            $normalized['type'] = 'palette';
            $this->debug['rule_applied'] = "Poids {$normalized['poids']}kg > 60kg : forcé en palette";
        }
        
        // Calcul pour chaque transporteur
        foreach ($this->tables as $carrier => $table) {
            try {
                $price = $this->calculateForCarrier($carrier, $normalized);
                $results[$carrier] = $price;
                
            } catch (Exception $e) {
                $results[$carrier] = null;
                $this->debug[$carrier]['error'] = $e->getMessage();
            }
        }
        
        return [
            'results' => $results,
            'debug' => $this->debug,
            'best' => $this->findBestRate($results)
        ];
    }
    
    private function normalizeParams(array $params): array {
        return [
            'departement' => str_pad(trim($params['departement'] ?? ''), 2, '0', STR_PAD_LEFT),
            'poids' => floatval($params['poids'] ?? 0),
            'type' => strtolower(trim($params['type'] ?? 'colis')),
            'adr' => (bool)($params['adr'] ?? false),
            'option_sup' => trim($params['option_sup'] ?? 'standard'),
            'enlevement' => (bool)($params['enlevement'] ?? false),
            'palettes' => max(0, intval($params['palettes'] ?? 0)),
        ];
    }
    
    private function calculateForCarrier(string $carrier, array $params): ?float {
        $this->debug[$carrier] = [];
        
        // 1. Récupération du tarif de base
        $baseTariff = $this->getBaseTariff($carrier, $params);
        if ($baseTariff === null) {
            $this->debug[$carrier]['result'] = 'Tarif de base non trouvé';
            return null;
        }
        
        $this->debug[$carrier]['base_tariff'] = $baseTariff;
        
        // 2. Calcul selon le poids
        $price = $baseTariff;
        
        // Règle : poids > 100kg = tarification proportionnelle
        if ($params['poids'] > 100) {
            $ratio = $params['poids'] / 100;
            $price = $baseTariff * $ratio;
            $this->debug[$carrier]['weight_ratio'] = $ratio;
        }
        
        $this->debug[$carrier]['price_after_weight'] = $price;
        
        // 3. Majorations
        $price = $this->addSurcharges($carrier, $price, $params);
        
        return round($price, 2);
    }
    
    private function getBaseTariff(string $carrier, array $params): ?float {
        $table = $this->tables[$carrier];
        $weight = $params['poids'];
        $dept = $params['departement'];
        
        // Déterminer la colonne selon le poids
        $weightColumn = $this->getWeightColumn($carrier, $weight);
        if (!$weightColumn) {
            $this->debug[$carrier]['weight_column'] = 'Colonne non trouvée pour ' . $weight . 'kg';
            return null;
        }
        
        $this->debug[$carrier]['weight_column'] = $weightColumn;
        
        // Requête
        $sql = "SELECT {$weightColumn} as tarif FROM {$table} WHERE num_departement = ? LIMIT 1";
        
        try {
            $stmt = $this->db->prepare($sql);
            $stmt->execute([$dept]);
            $row = $stmt->fetch(PDO::FETCH_ASSOC);
            
            $this->debug[$carrier]['sql'] = $sql;
            $this->debug[$carrier]['sql_params'] = [$dept];
            
            if ($row && $row['tarif'] > 0) {
                return (float)$row['tarif'];
            }
            
            $this->debug[$carrier]['sql_result'] = 'Aucun tarif trouvé ou tarif = 0';
            return null;
            
        } catch (Exception $e) {
            $this->debug[$carrier]['sql_error'] = $e->getMessage();
            return null;
        }
    }
    
    private function getWeightColumn(string $carrier, float $weight): ?string {
        switch ($carrier) {
            case 'xpo':
                if ($weight <= 99) return 'tarif_0_99';
                if ($weight <= 499) return 'tarif_100_499';
                if ($weight <= 999) return 'tarif_500_999';
                if ($weight <= 1999) return 'tarif_1000_1999';
                if ($weight <= 2999) return 'tarif_2000_2999';
                return null;
                
            case 'heppner':
                if ($weight <= 9) return 'tarif_0_9';
                if ($weight <= 19) return 'tarif_10_19';
                if ($weight <= 29) return 'tarif_20_29';
                if ($weight <= 39) return 'tarif_30_39';
                if ($weight <= 49) return 'tarif_40_49';
                if ($weight <= 59) return 'tarif_50_59';
                if ($weight <= 69) return 'tarif_60_69';
                if ($weight <= 79) return 'tarif_70_79';
                if ($weight <= 89) return 'tarif_80_89';
                if ($weight <= 99) return 'tarif_90_99';
                if ($weight <= 299) return 'tarif_100_299';
                if ($weight <= 499) return 'tarif_300_499';
                if ($weight <= 999) return 'tarif_500_999';
                if ($weight <= 1999) return 'tarif_1000_1999';
                return null;
        }
        
        return null;
    }
    
    private function addSurcharges(string $carrier, float $basePrice, array $params): float {
        $finalPrice = $basePrice;
        $surcharges = [];
        
        // 1. Majoration ADR
        if ($params['adr']) {
            $adrRate = $this->getADRRate($carrier);
            $adrSurcharge = $basePrice * ($adrRate / 100);
            $finalPrice += $adrSurcharge;
            $surcharges['adr'] = $adrSurcharge;
        }
        
        // 2. Options de service
        $serviceSurcharge = $this->getServiceSurcharge($params['option_sup']);
        $finalPrice += $serviceSurcharge;
        $surcharges['service'] = $serviceSurcharge;
        
        // 3. Enlèvement
        if ($params['enlevement']) {
            $pickupSurcharge = $this->getPickupSurcharge($carrier);
            $finalPrice += $pickupSurcharge;
            $surcharges['pickup'] = $pickupSurcharge;
        }
        
        // 4. Frais de palettes
        if ($params['type'] === 'palette' && $params['palettes'] > 0) {
            $paletteSurcharge = $this->getPaletteSurcharge($carrier, $params['palettes']);
            $finalPrice += $paletteSurcharge;
            $surcharges['palettes'] = $paletteSurcharge;
        }
        
        $this->debug[$carrier]['surcharges'] = $surcharges;
        $this->debug[$carrier]['final_price'] = $finalPrice;
        
        return $finalPrice;
    }
    
    private function getADRRate(string $carrier): float {
        try {
            $sql = "SELECT majoration_adr_taux FROM gul_taxes_transporteurs WHERE transporteur = ?";
            $stmt = $this->db->prepare($sql);
            $stmt->execute([$carrier]);
            $row = $stmt->fetch();
            
            if ($row && $row['majoration_adr_taux'] > 0) {
                return (float)$row['majoration_adr_taux'];
            }
        } catch (Exception $e) {
            // Silence
        }
        
        // Valeurs par défaut
        return $carrier === 'xpo' ? 20 : 25;
    }
    
    private function getServiceSurcharge(string $option): float {
        $costs = [
            'standard' => 0,
            'premium_matin' => 15,
            'rdv' => 12,
            'target' => 25
        ];
        
        return $costs[$option] ?? 0;
    }
    
    private function getPickupSurcharge(string $carrier): float {
        return $carrier === 'xpo' ? 25 : 0; // Heppner gratuit
    }
    
    private function getPaletteSurcharge(string $carrier, int $nb): float {
        $costPerPallet = $carrier === 'xpo' ? 8 : 10;
        return $costPerPallet * $nb;
    }
    
    private function findBestRate(array $results): ?array {
        $validResults = array_filter($results, function($price) {
            return $price !== null && $price > 0;
        });
        
        if (empty($validResults)) {
            return null;
        }
        
        $bestCarrier = array_keys($validResults, min($validResults))[0];
        
        return [
            'carrier' => $bestCarrier,
            'price' => $validResults[$bestCarrier],
            'name' => $this->carrierNames[$bestCarrier] ?? strtoupper($bestCarrier)
        ];
    }
}
?>
