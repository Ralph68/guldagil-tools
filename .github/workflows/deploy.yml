name: Deploy Laravel to o2switch (prod)

on:
  push:
    branches: [ "main" ]     # déploie dès qu'on pousse sur main
  workflow_dispatch:          # bouton "Run workflow" manuel

jobs:
  deploy-prod:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up PHP 8.3
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, intl, zip, curl, dom, gd, bcmath, exif, fileinfo, openssl, pdo, pdo_mysql
          coverage: none

      - name: Composer cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.composer/cache/files
          key: composer-${{ runner.os }}-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            composer-${{ runner.os }}-

      - name: Install Composer deps (prod)
        working-directory: ./laravel_app
        run: composer install --no-dev --prefer-dist --optimize-autoloader --no-interaction

      # On génère un .env à partir de tes secrets GitHub
      - name: Build .env file
        working-directory: ./laravel_app
        shell: bash
        run: |
          cat > .env << 'EOF'
          APP_NAME="Guldagil Portal"
          APP_ENV=production
          APP_DEBUG=false
          APP_URL=${{ secrets.APP_URL_PROD || 'https://gul.runser.ovh' }}

          LOG_CHANNEL=stack
          LOG_LEVEL=warning

          DB_CONNECTION=mysql
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=3306
          DB_DATABASE=${{ secrets.DB_NAME }}
          DB_USERNAME=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASS }}

          SESSION_DRIVER=file
          CACHE_STORE=file
          QUEUE_CONNECTION=database

          # Mail (remplis les secrets correspondants si besoin)
          MAIL_MAILER=smtp
          MAIL_HOST=${{ secrets.MAIL_HOST || '' }}
          MAIL_PORT=${{ secrets.MAIL_PORT || '587' }}
          MAIL_USERNAME=${{ secrets.MAIL_USERNAME || '' }}
          MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD || '' }}
          MAIL_ENCRYPTION=tls
          MAIL_FROM_ADDRESS=${{ secrets.MAIL_FROM_ADDRESS || 'noreply@gul.runser.ovh' }}
          MAIL_FROM_NAME="Guldagil Portal"
          EOF

      # Génère la clé et prépare les caches côté CI
      - name: Prepare app (key, caches)
        working-directory: ./laravel_app
        run: |
          php artisan key:generate --force
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache || true
          php artisan storage:link || true

      # Déploiement FTP complet vers o2switch
      - name: Upload to o2switch via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server:   ${{ secrets.FTP_SERVER_PROD }}
          username: ${{ secrets.FTP_USERNAME_PROD }}
          password: ${{ secrets.FTP_PASSWORD_PROD }}
          local-dir: ./laravel_app/
          server-dir: ${{ secrets.SERVER_DIR_PROD }}   # ex: /home/USER/public_html/laravel_app/
          protocol: ftps
          exclude: |
            **/.git*
            **/node_modules/**
            **/tests/**
            **/README.md
            **/phpunit.xml
            **/storage/logs/**
            **/storage/framework/cache/**
            **/storage/framework/testing/**
