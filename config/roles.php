<?php
/**
 * Titre: Syst√®me de gestion des r√¥les et permissions - VERSION COMPL√àTE CORRIG√âE
 * Chemin: /config/roles.php
 * Version: 0.5 beta + build auto
 */

if (!defined('ROOT_PATH')) {
    exit('Acc√®s direct interdit');
}

/**
 * Gestionnaire centralis√© des r√¥les et permissions
 * Architecture robuste pour la gestion des acc√®s modulaires
 */
class RoleManager 
{
    /**
     * D√©finition compl√®te des r√¥les syst√®me
     */
    private static $roles = [
        'dev' => [
            'name' => 'D√©veloppeur',
            'description' => 'Acc√®s complet d√©veloppement',
            'level' => 100,
            'color' => '#7c3aed',
            'icon' => 'üíª',
            'capabilities' => [
                'access_dev', 'view_debug', 'manage_system',
                'view_logs', 'edit_modules', 'manage_users',
                'edit_config', 'view_admin', 'manage_shipping',
                'view_quality', 'manage_adr', 'view_materiel',
                'manage_epi', 'quality_control', 'quality_analysis'
            ],
            'modules' => ['home', 'port', 'adr', 'epi', 'qualite', 'materiel', 'user', 'admin']
        ],
        'admin' => [
            'name' => 'Administrateur',
            'description' => 'Administration compl√®te',
            'level' => 95,
            'color' => '#dc2626',
            'icon' => 'üëë',
            'capabilities' => [
                'manage_users', 'manage_system', 'view_admin',
                'edit_config', 'view_logs', 'manage_shipping',
                'view_quality', 'manage_adr', 'view_materiel',
                'manage_epi', 'quality_control'
            ],
            'modules' => ['home', 'port', 'adr', 'epi', 'qualite', 'materiel', 'user', 'admin']
        ],
        'logistique' => [
            'name' => 'Logistique',
            'description' => 'Gestion transport et qualit√©',
            'level' => 60,
            'color' => '#059669',
            'icon' => 'üöõ',
            'capabilities' => [
                'manage_shipping', 'view_quality', 'manage_adr',
                'view_materiel', 'view_shipping'
            ],
            'modules' => ['home', 'port', 'qualite', 'adr', 'materiel']
        ],
        'qhse' => [
            'name' => 'QHSE',
            'description' => 'Qualit√©, Hygi√®ne, S√©curit√©, Environnement',
            'level' => 50,
            'color' => '#ea580c',
            'icon' => 'ü¶∫',
            'capabilities' => [
                'manage_adr', 'manage_epi', 'view_materiel',
                'quality_control', 'quality_analysis'
            ],
            'modules' => ['home', 'adr', 'epi', 'materiel']
        ],
        'labo' => [
            'name' => 'Laboratoire',
            'description' => 'Analyses et contr√¥les qualit√©',
            'level' => 40,
            'color' => '#3b82f6',
            'icon' => 'üß™',
            'capabilities' => [
                'view_quality', 'quality_control', 'quality_analysis',
                'view_materiel'
            ],
            'modules' => ['home', 'qualite', 'materiel']
        ],
        'user' => [
            'name' => 'Utilisateur',
            'description' => 'Acc√®s standard calculateur',
            'level' => 10,
            'color' => '#374151',
            'icon' => 'üë§',
            'capabilities' => ['view_shipping'],
            'modules' => ['home', 'port', 'materiel']
        ]
    ];

    /**
     * Hi√©rarchie des r√¥les (h√©ritage des permissions)
     */
    private static $hierarchy = [
        'dev' => ['admin', 'logistique', 'qhse', 'labo', 'user'],
        'admin' => ['logistique', 'qhse', 'labo', 'user'],
        'logistique' => ['user'],
        'qhse' => ['user'],
        'labo' => ['user']
    ];

    /**
     * Obtenir tous les r√¥les d√©finis
     */
    public static function getAllRoles(): array 
    {
        return self::$roles;
    }

    /**
     * Obtenir les informations d'un r√¥le sp√©cifique
     */
    public static function getRole(string $role): ?array 
    {
        return self::$roles[$role] ?? null;
    }

    /**
     * V√©rifier si un r√¥le peut acc√©der √† un module
     */
    public static function canAccessModule(string $role, string $module): bool 
    {
        $roleData = self::getRole($role);
        if (!$roleData) {
            return false;
        }

        return in_array($module, $roleData['modules']);
    }

    /**
     * V√©rifier si un r√¥le poss√®de une capacit√© sp√©cifique
     */
    public static function hasCapability(string $role, string $capability): bool 
    {
        $roleData = self::getRole($role);
        if (!$roleData) {
            return false;
        }

        // V√©rifier les capacit√©s directes
        if (in_array($capability, $roleData['capabilities'])) {
            return true;
        }

        // V√©rifier l'h√©ritage hi√©rarchique
        if (isset(self::$hierarchy[$role])) {
            foreach (self::$hierarchy[$role] as $inheritedRole) {
                if (self::hasCapability($inheritedRole, $capability)) {
                    return true;
                }
            }
        }

        return false;
    }

    /**
     * Obtenir tous les modules accessibles pour un r√¥le
     */
    public static function getAccessibleModules(string $role): array 
    {
        $roleData = self::getRole($role);
        if (!$roleData) {
            return [];
        }

        $modules = $roleData['modules'];

        // Ajouter les modules des r√¥les h√©rit√©s
        if (isset(self::$hierarchy[$role])) {
            foreach (self::$hierarchy[$role] as $inheritedRole) {
                $inheritedModules = self::getAccessibleModules($inheritedRole);
                $modules = array_unique(array_merge($modules, $inheritedModules));
            }
        }

        return $modules;
    }

    /**
     * Comparer le niveau hi√©rarchique de deux r√¥les
     */
    public static function isRoleHigher(string $role1, string $role2): bool 
    {
        $level1 = self::$roles[$role1]['level'] ?? 0;
        $level2 = self::$roles[$role2]['level'] ?? 0;
        
        return $level1 > $level2;
    }

    /**
     * Obtenir les r√¥les qu'un utilisateur peut g√©rer
     */
    public static function getManageableRoles(string $userRole): array 
    {
        $userLevel = self::$roles[$userRole]['level'] ?? 0;
        $manageableRoles = [];

        foreach (self::$roles as $role => $data) {
            if ($data['level'] < $userLevel) {
                $manageableRoles[$role] = $data;
            }
        }

        return $manageableRoles;
    }

    /**
     * Valider l'existence d'un r√¥le
     */
    public static function isValidRole(string $role): bool 
    {
        return isset(self::$roles[$role]);
    }

    /**
     * G√©n√©rer un badge HTML pour un r√¥le
     */
    public static function getRoleBadge(string $role): string 
    {
        $roleData = self::getRole($role);
        if (!$roleData) {
            return '<span class="role-badge role-unknown">Inconnu</span>';
        }

        return sprintf(
            '<span class="role-badge" style="background-color: %s; color: white; padding: 3px 8px; border-radius: 4px; font-size: 12px;">%s %s</span>',
            $roleData['color'],
            $roleData['icon'],
            htmlspecialchars($roleData['name'])
        );
    }

    /**
     * Configuration compl√®te pour l'interface d'administration
     */
    public static function getAdminConfig(): array 
    {
        return [
            'roles' => self::$roles,
            'hierarchy' => self::$hierarchy,
            'permissions' => [
                'manage_users' => 'Gestion des utilisateurs',
                'manage_system' => 'Configuration syst√®me',
                'view_admin' => 'Acc√®s administration',
                'edit_config' => 'Modification configuration',
                'view_logs' => 'Consultation des logs',
                'access_dev' => 'Outils d√©veloppeur',
                'manage_shipping' => 'Gestion transport',
                'view_quality' => 'Consultation qualit√©',
                'manage_adr' => 'Gestion ADR',
                'view_materiel' => 'Consultation materiel',
                'manage_epi' => 'Gestion EPI',
                'quality_control' => 'Contr√¥le qualit√©',
                'view_shipping' => 'Consultation transport',
                'quality_analysis' => 'Analyses qualit√©',
                'view_epi' => 'Consultation EPI'
            ]
        ];
    }

    /**
     * Obtenir les statistiques des r√¥les
     */
    public static function getRoleStats(): array 
    {
        $stats = [
            'total_roles' => count(self::$roles),
            'total_modules' => 0,
            'total_capabilities' => 0,
            'roles_by_level' => []
        ];

        $all_modules = [];
        $all_capabilities = [];

        foreach (self::$roles as $role => $data) {
            $all_modules = array_merge($all_modules, $data['modules']);
            $all_capabilities = array_merge($all_capabilities, $data['capabilities']);
            $stats['roles_by_level'][$data['level']] = $role;
        }

        $stats['total_modules'] = count(array_unique($all_modules));
        $stats['total_capabilities'] = count(array_unique($all_capabilities));

        return $stats;
    }
}

/**
 * FONCTIONS UTILITAIRES GLOBALES POUR COMPATIBILIT√â
 */

/**
 * V√©rifier l'acc√®s √† un module (wrapper pour compatibilit√©)
 */
if (!function_exists('canAccessModule')) {
    function canAccessModule(string $module_key, array $module_data, string $user_role): bool 
    {
        return RoleManager::canAccessModule($user_role, $module_key);
    }
}

/**
 * Note: shouldShowModule() est d√©finie dans /config/functions.php
 * pour √©viter les conflits de red√©claration
 */

/**
 * Obtenir les modules pour la navigation
 */
if (!function_exists('getNavigationModules')) {
    function getNavigationModules(string $user_role, array $all_modules): array 
    {
        $accessibleModules = RoleManager::getAccessibleModules($user_role);
        $navigation = [];

        foreach ($all_modules as $key => $module) {
            if ($key !== 'home' && in_array($key, $accessibleModules)) {
                $navigation[$key] = $module;
            }
        }

        return $navigation;
    }
}

/**
 * V√©rifier une permission d'administration
 */
if (!function_exists('hasAdminPermission')) {
    function hasAdminPermission(string $user_role, string $permission): bool 
    {
        return RoleManager::hasCapability($user_role, $permission);
    }
}

/**
 * Obtenir la classe CSS pour un badge de r√¥le
 */
if (!function_exists('getRoleBadgeClass')) {
    function getRoleBadgeClass(string $role): string 
    {
        $roleData = RoleManager::getRole($role);
        return $roleData ? 'role-' . $role : 'role-user';
    }
}

/**
 * V√©rifier si l'utilisateur actuel peut g√©rer un autre utilisateur
 */
if (!function_exists('canManageUser')) {
    function canManageUser(string $currentUserRole, string $targetUserRole): bool 
    {
        return RoleManager::isRoleHigher($currentUserRole, $targetUserRole);
    }
}

/**
 * Obtenir la couleur d'un r√¥le
 */
if (!function_exists('getRoleColor')) {
    function getRoleColor(string $role): string 
    {
        $roleData = RoleManager::getRole($role);
        return $roleData ? $roleData['color'] : '#374151';
    }
}

/**
 * Obtenir l'ic√¥ne d'un r√¥le
 */
if (!function_exists('getRoleIcon')) {
    function getRoleIcon(string $role): string 
    {
        $roleData = RoleManager::getRole($role);
        return $roleData ? $roleData['icon'] : 'üë§';
    }
}

/**
 * Validation finale du fichier
 */
if (!class_exists('RoleManager')) {
    throw new Error('Erreur critique: La classe RoleManager n\'a pas √©t√© d√©finie correctement');
}

// Test de base pour v√©rifier que tout fonctionne
try {
    $testRoles = RoleManager::getAllRoles();
    if (empty($testRoles)) {
        throw new Error('Aucun r√¥le d√©fini');
    }
} catch (Error $e) {
    error_log('Erreur dans roles.php: ' . $e->getMessage());
    throw $e;
}

?>
