<?php
/**
 * Fichier de configuration et de gestion des r√¥les et permissions du portail.
 * C'est la source de v√©rit√© pour tous les droits d'acc√®s.
 */

class RoleManager 
{
    /**
     * D√©finition des r√¥les, de leurs capacit√©s et des modules accessibles.
     * Le niveau (level) d√©finit la hi√©rarchie.
     */
    private static $roles = [
        'dev' => [
            'name' => 'D√©veloppeur',
            'description' => 'Acc√®s total √† toutes les fonctionnalit√©s et configurations',
            'level' => 100,
            'color' => '#d946ef',
            'icon' => 'üíª',
            'capabilities' => ['*'], // Joker pour toutes les permissions
            'modules' => ['*'] // Joker pour tous les modules
        ],
        'admin' => [
            'name' => 'Administrateur',
            'description' => 'Gestion compl√®te des utilisateurs et des modules',
            'level' => 90,
            'color' => '#ef4444',
            'icon' => 'üëë',
            'capabilities' => [
                'manage_users', 'manage_system', 'view_admin', 'edit_config',
                'view_logs', 'manage_shipping', 'manage_adr', 'manage_epi',
                'view_quality', 'view_materiel'
            ],
            'modules' => ['home', 'port', 'adr', 'qualite', 'maintenance', 'admin', 'user']
        ],
        'logistique' => [
            'name' => 'Logistique',
            'description' => 'Gestion des transports et des exp√©ditions',
            'level' => 60,
            'color' => '#f97316',
            'icon' => 'üöö',
            'capabilities' => [
                'manage_shipping', 'view_adr', 'view_materiel'
            ],
            'modules' => ['home', 'port', 'adr', 'maintenance']
        ],
        'qhse' => [
            'name' => 'QHSE',
            'description' => 'Qualit√©, Hygi√®ne, S√©curit√©, Environnement',
            'level' => 50,
            'color' => '#ea580c',
            'icon' => 'ü¶∫',
            'capabilities' => [
                'manage_adr', 'manage_epi', 'view_materiel',
                'quality_control', 'quality_analysis'
            ],
            'modules' => ['home', 'adr', 'qualite', 'maintenance']
        ],
        'labo' => [
            'name' => 'Laboratoire',
            'description' => 'Analyses et contr√¥les qualit√©',
            'level' => 40,
            'color' => '#3b82f6',
            'icon' => 'üß™',
            'capabilities' => [
                'view_quality', 'quality_control', 'quality_analysis',
                'view_materiel'
            ],
            'modules' => ['home', 'qualite']
        ],
        'user' => [
            'name' => 'Utilisateur',
            'description' => 'Acc√®s standard calculateur',
            'level' => 10,
            'color' => '#374151',
            'icon' => 'üë§',
            'capabilities' => ['view_shipping'],
            'modules' => ['home', 'port', 'user']
        ]
    ];

    /**
     * Hi√©rarchie des r√¥les (h√©ritage des permissions)
     */
    private static $hierarchy = [
        'dev' => ['admin'],
        'admin' => ['logistique', 'qhse', 'labo'],
        'logistique' => ['user'],
        'qhse' => ['user'],
        'labo' => ['user']
    ];

    /**
     * Obtenir tous les r√¥les d√©finis
     */
    public static function getAllRoles(): array 
    {
        return self::$roles;
    }

    /**
     * Obtenir les informations d'un r√¥le sp√©cifique
     */
    public static function getRole(string $role): ?array 
    {
        return self::$roles[$role] ?? null;
    }

    /**
     * V√©rifier si un r√¥le peut acc√©der √† un module
     */
    public static function canAccessModule(string $role, string $module): bool 
    {
        $roleData = self::getRole($role);
        if (!$roleData) {
            return false;
        }
        
        if (in_array('*', $roleData['modules'])) {
            return true;
        }

        return in_array($module, $roleData['modules']);
    }

    /**
     * V√©rifier si un r√¥le poss√®de une capacit√© sp√©cifique
     */
    public static function hasCapability(string $role, string $capability): bool 
    {
        $roleData = self::getRole($role);
        if (!$roleData) {
            return false;
        }

        if (in_array('*', $roleData['capabilities'])) {
            return true;
        }

        if (in_array($capability, $roleData['capabilities'])) {
            return true;
        }

        if (isset(self::$hierarchy[$role])) {
            foreach (self::$hierarchy[$role] as $inheritedRole) {
                if (self::hasCapability($inheritedRole, $capability)) {
                    return true;
                }
            }
        }

        return false;
    }

    /**
     * Obtenir tous les modules accessibles pour un r√¥le
     */
    public static function getAccessibleModules(string $role): array 
    {
        $roleData = self::getRole($role);
        if (!$roleData) {
            return [];
        }

        if (in_array('*', $roleData['modules'])) {
            $all_modules = [];
            foreach(self::$roles as $r) {
                if(isset($r['modules'])) {
                    $all_modules = array_merge($all_modules, $r['modules']);
                }
            }
            return array_keys(array_flip($all_modules));
        }

        $modules = $roleData['modules'];

        if (isset(self::$hierarchy[$role])) {
            foreach (self::$hierarchy[$role] as $inheritedRole) {
                $inheritedModules = self::getAccessibleModules($inheritedRole);
                $modules = array_unique(array_merge($modules, $inheritedModules));
            }
        }

        return $modules;
    }

    /**
     * Comparer le niveau hi√©rarchique de deux r√¥les
     */
    public static function isRoleHigher(string $role1, string $role2): bool 
    {
        $level1 = self::$roles[$role1]['level'] ?? 0;
        $level2 = self::$roles[$role2]['level'] ?? 0;
        
        return $level1 > $level2;
    }

    /**
     * Obtenir les r√¥les qu'un utilisateur peut g√©rer
     */
    public static function getManageableRoles(string $userRole): array 
    {
        $userLevel = self::$roles[$userRole]['level'] ?? 0;
        $manageableRoles = [];

        foreach (self::$roles as $role => $data) {
            if (($data['level'] ?? 0) < $userLevel) {
                $manageableRoles[$role] = $data;
            }
        }

        return $manageableRoles;
    }

    /**
     * Valider l'existence d'un r√¥le
     */
    public static function isValidRole(string $role): bool 
    {
        return isset(self::$roles[$role]);
    }

    /**
     * G√©n√©rer un badge HTML pour un r√¥le
     */
    public static function getRoleBadge(string $role): string 
    {
        $roleData = self::getRole($role);
        if (!$roleData) {
            return '<span class="role-badge role-unknown">Inconnu</span>';
        }

        return sprintf(
            '<span class="role-badge" style="background-color: %s; color: white; padding: 3px 8px; border-radius: 4px; font-size: 12px;">%s %s</span>',
            $roleData['color'] ?? '#374151',
            $roleData['icon'] ?? 'üë§',
            htmlspecialchars($roleData['name'])
        );
    }
}

// Configuration de la dur√©e des sessions (par d√©faut : 8 heures)
if (!defined('SESSION_TIMEOUT')) {
    define('SESSION_TIMEOUT', 8 * 60 * 60); // 8 heures en secondes
}

ini_set('session.gc_maxlifetime', SESSION_TIMEOUT);
session_set_cookie_params(SESSION_TIMEOUT);

/**
 * FONCTIONS UTILITAIRES GLOBALES POUR COMPATIBILIT√â
 * Ces fonctions agissent comme des wrappers pour la classe RoleManager
 * afin d'assurer la compatibilit√© avec l'ancien code.
 */

if (!function_exists('canAccessModule')) {
    function canAccessModule(string $module_key, array $module_data, string $user_role): bool 
    {
        return RoleManager::canAccessModule($user_role, $module_key);
    }
}

if (!function_exists('getNavigationModules')) {
    /**
     * R√©cup√®re les modules de navigation en fonction du r√¥le de l'utilisateur
     * @param string $userRole Le r√¥le de l'utilisateur
     * @param array $modules Tableau des modules disponibles
     * @return array Modules filtr√©s selon les droits
     */
    function getNavigationModules($userRole, $modules) {
        $filteredModules = [];
        
        foreach ($modules as $id => $module) {
            // Sauter le module home qui est toujours accessible via le logo
            if ($id === 'home') continue;
            
            // V√©rifier si le module est restreint √† certains r√¥les
            if (isset($module['restricted']) && is_array($module['restricted'])) {
                if (!in_array($userRole, $module['restricted'])) {
                    continue; // Sauter ce module si l'utilisateur n'a pas le r√¥le requis
                }
            }
            
            // Ajouter le module au tableau filtr√©
            $filteredModules[$id] = $module;
        }
        
        return $filteredModules;
    }
}

if (!function_exists('hasAdminPermission')) {
    function hasAdminPermission(string $user_role, string $permission): bool 
    {
        return RoleManager::hasCapability($user_role, $permission);
    }
}

if (!function_exists('getRoleBadgeClass')) {
    function getRoleBadgeClass(string $role): string 
    {
        return RoleManager::getRole($role) ? 'role-' . $role : 'role-user';
    }
}

if (!function_exists('canManageUser')) {
    function canManageUser(string $currentUserRole, string $targetUserRole): bool 
    {
        return RoleManager::isRoleHigher($currentUserRole, $targetUserRole);
    }
}

if (!function_exists('getRoleColor')) {
    function getRoleColor(string $role): string 
    {
        $roleData = RoleManager::getRole($role);
        return $roleData['color'] ?? '#374151';
    }
}

if (!function_exists('getRoleIcon')) {
    function getRoleIcon(string $role): string 
    {
        $roleData = RoleManager::getRole($role);
        return $roleData['icon'] ?? 'üë§';
    }
}

/**
 * Note: shouldShowModule() est d√©finie dans /config/functions.php
 * pour √©viter les conflits de red√©claration
 */

/**
 * Obtenir les modules pour la navigation
 */
if (!function_exists('getNavigationModules')) {
    function getNavigationModules(string $user_role, array $all_modules): array 
    {
        $accessibleModules = RoleManager::getAccessibleModules($user_role);
        $navigation = [];

        foreach ($all_modules as $key => $module) {
            if ($key !== 'home' && in_array($key, $accessibleModules)) {
                $navigation[$key] = $module;
            }
        }

        return $navigation;
    }
}

/**
 * V√©rifier une permission d'administration
 */
if (!function_exists('hasAdminPermission')) {
    function hasAdminPermission(string $user_role, string $permission): bool 
    {
        return RoleManager::hasCapability($user_role, $permission);
    }
}

/**
 * Obtenir la classe CSS pour un badge de r√¥le
 */
if (!function_exists('getRoleBadgeClass')) {
    function getRoleBadgeClass(string $role): string 
    {
        $roleData = RoleManager::getRole($role);
        return $roleData ? 'role-' . $role : 'role-user';
    }
}

/**
 * V√©rifier si l'utilisateur actuel peut g√©rer un autre utilisateur
 */
if (!function_exists('canManageUser')) {
    function canManageUser(string $currentUserRole, string $targetUserRole): bool 
    {
        return RoleManager::isRoleHigher($currentUserRole, $targetUserRole);
    }
}

/**
 * Obtenir la couleur d'un r√¥le
 */
if (!function_exists('getRoleColor')) {
    function getRoleColor(string $role): string 
    {
        $roleData = RoleManager::getRole($role);
        return $roleData ? $roleData['color'] : '#374151';
    }
}

/**
 * Obtenir l'ic√¥ne d'un r√¥le
 */
if (!function_exists('getRoleIcon')) {
    function getRoleIcon(string $role): string 
    {
        $roleData = RoleManager::getRole($role);
        return $roleData ? $roleData['icon'] : 'üë§';
    }
}

/**
 * Validation finale du fichier
 */
if (!class_exists('RoleManager')) {
    throw new Error('Erreur critique: La classe RoleManager n\'a pas √©t√© d√©finie correctement');
}

// Test de base pour v√©rifier que tout fonctionne
try {
    $testRoles = RoleManager::getAllRoles();
    if (empty($testRoles)) {
        throw new Error('Aucun r√¥le d√©fini');
    }
} catch (Error $e) {
    error_log('Erreur dans roles.php: ' . $e->getMessage());
    throw $e;
}

?>
